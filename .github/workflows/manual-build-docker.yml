---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/refs/heads/master/src/schemas/json/github-workflow.json
name: Manual Docker Image Build

on:
  workflow_dispatch:
    inputs:
      tag-suffix:
        description: "Optional tag suffix (e.g., 'test', 'hotfix'). If empty, uses 'manual'"
        required: false
        type: string
        default: "manual"

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: public.ecr.aws/o5q6k5w4/karnot-operator/txn_replay_service

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR Public
        id: login-ecr-public
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image tags
        id: tags
        run: |
          SHA=$(git rev-parse --short=7 "$GITHUB_SHA")
          SUFFIX="${{ inputs.tag-suffix }}"

          # Primary tag with suffix and SHA
          PRIMARY_TAG="${{ env.ECR_REPOSITORY }}:${SUFFIX}-${SHA}"
          echo "primary-tag=$PRIMARY_TAG" >> $GITHUB_OUTPUT

          TAGS="$PRIMARY_TAG"

          # Add latest tag if building from main branch
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            LATEST_TAG="${{ env.ECR_REPOSITORY }}:${SUFFIX}-latest"
            echo "latest-tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            TAGS="$TAGS,$LATEST_TAG"
          fi

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Generated tags: $TAGS"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image details
        run: |
          echo "=================================================="
          echo "Docker image built and pushed successfully!"
          echo "Primary tag: ${{ steps.tags.outputs.primary-tag }}"
          if [[ -n "${{ steps.tags.outputs.latest-tag }}" ]]; then
            echo "Latest tag: ${{ steps.tags.outputs.latest-tag }}"
          fi
          echo "=================================================="
